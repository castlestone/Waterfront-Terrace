<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ask-My-Docs – Waterfront Terrace</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Light theme variables from styles/light.css */
        :root {
            color-scheme: light;
            --bg: #f8fafc;
            --text: #0f172a;
            --muted: #475569;
            --card: #ffffff;
            --border: #e2e8f0;
            --accent: #2563eb;
            --accent-foreground: #ffffff;
        }

        /* Merged and custom CSS */
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        h1 {
            font-size: clamp(28px, 4vw, 44px);
            font-weight: bold;
        }
        
        .bubble {
            padding: 0.65rem 0.8rem;
            border-radius: 20px;
            max-width: 85%;
            white-space: pre-wrap;
        }
        
        .user {
            background-color: var(--accent);
            color: var(--accent-foreground);
            border-bottom-right-radius: 4px;
        }
        
        .assistant {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text);
            border-bottom-left-radius: 4px;
        }

        textarea#q {
            background: #fff;
            color: var(--text);
            border: 1px solid var(--border);
        }

        button#send {
            background: var(--accent);
            color: var(--accent-foreground);
            border: 1px solid var(--accent);
        }

        a {
            color: var(--accent);
        }

        #chat {
            height: auto !important;
            max-height: none !important;
            min-height: 200px;
        }

    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div class="max-w-4xl mx-auto px-4 py-8 md:py-16">
        <header>
            <h1 class="mb-1 font-bold text-[clamp(28px,4vw,44px)]">
 Ask Waterfront Terrace
 <span class="inline-block px-2 py-0.5 rounded-full bg-black text-white text-xs ml-2">governance</span>
</h1>
            <p class="text-slate-600 mt-1">Answers based only on the official governing documents.</p>
            <img alt="Waterfront Terrace" src="./waterfront.png" style="display:block; margin:1rem auto; max-width:100%; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.4);"/>
        </header>

        <div class="bg-white rounded-xl shadow-lg p-6 my-8">
            <p>Welcome to the <strong>Waterfront Terrace Governance Assistant</strong>. This tool provides clear, document-based answers to questions about how Halifax County Condominium Corporation No. 227 is governed. All responses are drawn strictly from the official governing documents — including the Declaration, By-laws, and the Nova Scotia Condominium Act and Regulations. If the information is not in these documents, the assistant will tell you so. Use this page to quickly find accurate guidance on meetings, voting, common element rules, contractor access, financial authority, and more.</p>
        </div>
        
        <div class="bg-white rounded-xl shadow-2xl p-4">
            <div aria-busy="false" aria-live="polite" id="chat" class="flex flex-col gap-2 p-2 rounded-lg bg-slate-50 overflow-visible"></div>
            <div class="sources opacity-85 mt-2 text-sm" id="sources"></div>
            <form id="form" class="flex gap-2 mt-3 items-center">
                <textarea id="q" placeholder="Ask a question about your docs…" required class="flex-1 resize-y min-h-[48px] max-h-[200px] rounded-full px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200"></textarea>
                <button id="send" class="border-0 rounded-full px-6 py-3 font-semibold text-white cursor-pointer transition-transform duration-200 hover:-translate-y-0.5 disabled:opacity-60 disabled:cursor-not-allowed">Ask</button>
            </form>
        </div>
        
        <footer class="mt-4 text-slate-600 text-xs">Pro tip: ask specific questions for best retrieval (e.g., “How many board members are allowed?”).</footer>
    </div>

    <script>
        const chat = document.getElementById('chat');
        const form = document.getElementById('form');
        const q = document.getElementById('q');
        const send = document.getElementById('send');
        const sourcesEl = document.getElementById('sources');

        function bubble(text, cls) {
            const d = document.createElement('div');
            d.className = `bubble ${cls}`;
            d.textContent = text;
            chat.appendChild(d);
            chat.scrollTop = chat.scrollHeight;
            return d;
        }

        function showSources(sources) {
            if (!sources || !sources.length) {
                sourcesEl.textContent = '';
                return;
            }
            sourcesEl.innerHTML = 'Sources: ' + sources.map(s => `<code>${s}</code>`).join(', ');
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = q.value.trim();
            if (!msg) return;
            bubble(msg, 'user');
            q.value = '';
            q.focus();
            const a = bubble('', 'assistant');
            showSources([]);
            send.disabled = true;
            chat.setAttribute('aria-busy', 'true');
            
            try {
                const resp = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });

                if (!resp.ok || !resp.body) {
                    a.textContent = `Error: ${resp.status} ${resp.statusText}`;
                    return;
                }

                const reader = resp.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let sources = [];
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    
                    for (let i = 0; i < lines.length - 1; i++) {
                        const line = lines[i].trimStart();
                        if (!line.startsWith('data:')) continue;
                        const data = line.slice(5).trim();
                        if (data === '' || data === '[DONE]') continue;
                        
                        try {
                            const evt = JSON.parse(data);
                            if (evt.output_text) {
                                a.textContent += evt.output_text;
                            }
                            if (evt.sources) {
                                sources = evt.sources;
                                showSources(sources);
                            }
                        } catch (err) {
                            console.error('Failed to parse JSON:', err);
                        }
                    }
                    buffer = lines[lines.length - 1];
                    chat.scrollTop = chat.scrollHeight;
                }
            } catch (err) {
                a.textContent = 'Network error: ' + err.message;
            } finally {
                send.disabled = false;
                chat.setAttribute('aria-busy', 'false');
            }
        });
    </script>
</body>
</html>
